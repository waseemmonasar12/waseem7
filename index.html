<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ” Ø±Ø³Ø§Ø¦Ù„ Ù…Ø´ÙØ±Ø© - Ø¢Ù…Ù†Ø© Ø·Ø±ÙÙŠÙ‹Ø§</title>

  <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root {
      --primary-color: #3182ce;
      --secondary-color: #2d3748;
      --accent-color: #e53e3e;
      --success-color: #38a169;
      --glass-bg: rgba(255, 255, 255, 0.95);
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      color: #1a202c;
      padding-top: 70px;
      direction: rtl;
      min-height: 100vh;
    }

    /* Navbar */
    .navbar {
      position: fixed;
      top: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 0 20px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 100;
    }
    
    .nav-logo { 
      font-size: 1.6rem; 
      font-weight: bold; 
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .nav-links a {
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      margin-right: 20px;
      font-weight: 600;
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.3s;
    }
    
    .nav-links a:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .nav-links a.active { 
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    /* Main Container */
    .container { 
      max-width: 800px; 
      margin: 20px auto; 
      padding: 20px; 
    }
    
    .page { 
      display: none; 
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      animation: fadeIn 0.4s;
    }
    
    .page.active { 
      display: block; 
    }
    
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(20px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    h1, h2 { 
      margin: 20px 0; 
      color: var(--secondary-color); 
      text-align: center;
    }
    
    h1 { font-size: 2.2rem; }
    h2 { font-size: 1.8rem; }
    
    p { 
      margin: 15px 0; 
      line-height: 1.6; 
      color: #4a5568;
    }

    label { 
      display: block; 
      margin: 20px 0 8px; 
      font-weight: 600; 
      color: #2d3748;
    }
    
    input, textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      transition: border-color 0.3s;
      background: rgba(255, 255, 255, 0.9);
    }
    
    input:focus, textarea:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
    }
    
    textarea { 
      min-height: 120px; 
      resize: vertical; 
    }

    /* Buttons */
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    
    button {
      flex: 1;
      min-width: 150px;
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
    }
    
    button:active { 
      transform: translateY(0);
    }
    
    #decryptBtn, .btn-danger { 
      background: var(--accent-color); 
    }
    
    .btn-success { 
      background: var(--success-color); 
    }
    
    .btn-secondary { 
      background: #718096; 
    }

    /* Result Boxes */
    .result-box, .link-display {
      background: #f7fafc;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      white-space: pre-wrap;
      word-break: break-word;
      border: 2px dashed #cbd5e0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    
    .link-display {
      background: #e6fffa;
      border-color: #81e6d9;
      direction: ltr;
      text-align: left;
    }

    #locationMap {
      height: 250px;
      width: 100%;
      border-radius: 12px;
      margin-top: 20px;
      display: none;
      border: 2px solid #e2e8f0;
    }

    /* Home Page */
    .hero {
      text-align: center;
      padding: 30px 0;
    }
    
    .hero-icon {
      font-size: 4rem;
      color: var(--primary-color);
      margin-bottom: 20px;
    }
    
    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 40px 0;
    }
    
    .feature {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      text-align: center;
    }
    
    .feature i {
      font-size: 2.5rem;
      color: var(--primary-color);
      margin-bottom: 15px;
    }

    /* Loading Spinner */
    .spinner {
      display: none;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden { display: none !important; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 10px; }
      .page { padding: 20px; }
      .navbar { padding: 0 15px; height: 60px; }
      .nav-links a { margin-right: 10px; padding: 6px 10px; }
      button { min-width: 100%; }
      .features { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-logo">
      <i class="fas fa-user-shield"></i>
      Ø±Ø³Ø§Ø¦Ù„ Ù…Ø´ÙØ±Ø©
    </div>
    <div class="nav-links">
      <a href="#" class="nav-item active" data-page="home">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="#" class="nav-item" data-page="encrypt">ğŸ” ØªØ´ÙÙŠØ±</a>
      <a href="#" class="nav-item" data-page="decrypt">ğŸ”“ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±</a>
    </div>
  </nav>

  <div class="container">

    <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="home" class="page active">
      <div class="hero">
        <div class="hero-icon">
          <i class="fas fa-lock"></i>
        </div>
        <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø´ÙØ±Ø©</h1>
        <p>ØªØ·Ø¨ÙŠÙ‚ Ø¢Ù…Ù† Ù„Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø³Ø±ÙŠ Ø¹Ø¨Ø± Ø±ÙˆØ§Ø¨Ø· Ù…Ø´ÙØ±Ø© Ø·Ø±ÙÙŠÙ‹Ø§. Ù„Ø§ ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®ÙˆØ§Ø¯Ù….</p>
      </div>

      <div class="features">
        <div class="feature">
          <i class="fas fa-shield-alt"></i>
          <h3>Ø¢Ù…Ù† ØªÙ…Ø§Ù…Ù‹Ø§</h3>
          <p>ØªØ´ÙÙŠØ± Ù…Ù† Ø·Ø±Ù Ø¥Ù„Ù‰ Ø·Ø±Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø§ÙŠÙŠØ± AES-GCM</p>
        </div>
        <div class="feature">
          <i class="fas fa-link"></i>
          <h3>Ø±ÙˆØ§Ø¨Ø· Ù…Ø´ÙØ±Ø©</h3>
          <p>ØªØ­ÙˆÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„Ùƒ Ø¥Ù„Ù‰ Ø±ÙˆØ§Ø¨Ø· Ø¢Ù…Ù†Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­Ù‡Ø§ Ø¥Ù„Ø§ Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</p>
        </div>
        <div class="feature">
          <i class="fas fa-map-marker-alt"></i>
          <h3>Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3>
          <p>Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø±ÙØ§Ù‚ Ù…ÙˆÙ‚Ø¹ Ø¬ØºØ±Ø§ÙÙŠ Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø´ÙØ±Ø©</p>
        </div>
      </div>

      <div class="btn-group">
        <button onclick="showPage('encrypt')" class="btn-primary">
          <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </button>
        <button onclick="showPage('decrypt')" class="btn-success">
          <i class="fas fa-key"></i> ÙÙƒ ØªØ´ÙÙŠØ± Ø±Ø³Ø§Ù„Ø©
        </button>
      </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„ØªØ´ÙÙŠØ± -->
    <div id="encrypt" class="page">
      <h2><i class="fas fa-lock"></i> ØªØ´ÙÙŠØ± Ø±Ø³Ø§Ù„Ø©</h2>
      
      <label><i class="fas fa-user"></i> Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
      <input type="text" id="senderName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯">

      <label><i class="fas fa-comment"></i> Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</label>
      <textarea id="message" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ø§Ù„Ø³Ø±ÙŠØ© Ù‡Ù†Ø§..."></textarea>

      <label><i class="fas fa-key"></i> ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:</label>
      <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ù‚ÙˆÙŠØ© (Ù„Ø§ ØªÙ†Ø³Ø§Ù‡Ø§!)">

      <div class="btn-group">
        <button onclick="encryptAndShare()" class="btn-primary">
          <i class="fas fa-magic"></i> ØªØ´ÙÙŠØ± ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø·
        </button>
        <button onclick="showPage('home')" class="btn-secondary">
          <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
        </button>
      </div>

      <div class="spinner" id="encryptSpinner"></div>

      <div id="linkContainer" class="hidden">
        <label><i class="fas fa-link"></i> Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø´ÙØ±Ø©:</label>
        <div class="link-display" id="shareLink"></div>
        
        <div class="btn-group">
          <button onclick="copyToClipboard()" class="btn-success">
            <i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
          </button>
          <button onclick="shareViaApps()" class="btn-primary">
            <i class="fas fa-share-alt"></i> Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª
          </button>
        </div>
        
        <div class="result-box" id="copyStatus"></div>
      </div>
    </div>

    <!-- ØµÙØ­Ø© ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± -->
    <div id="decrypt" class="page">
      <h2><i class="fas fa-unlock"></i> ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©</h2>
      
      <div id="messageDetected" class="result-box hidden" style="background: #feebc8;">
        <i class="fas fa-info-circle"></i> ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø±Ø³Ø§Ù„Ø© Ù…Ø´ÙØ±Ø© ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
      </div>
      
      <label><i class="fas fa-key"></i> ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:</label>
      <input type="password" id="decryptPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„ØªÙŠ Ø£Ø¹Ø·Ø§Ù‡Ø§ Ù„Ùƒ Ø§Ù„Ù…Ø±Ø³Ù„">

      <div class="btn-group">
        <button id="decryptBtn" onclick="decryptMessage()" class="btn-danger">
          <i class="fas fa-eye"></i> ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        </button>
        <button onclick="showPage('home')" class="btn-secondary">
          <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
        </button>
      </div>

      <div class="spinner" id="decryptSpinner"></div>

      <div id="output" class="hidden result-box">
        <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; color: var(--primary-color);">
          <i class="fas fa-envelope-open-text"></i> Ø§Ù„Ø±Ø³Ø§Ù„Ø©:
        </div>
        <div id="messageContent"></div>
        <div id="locationInfo" class="hidden" style="margin-top: 20px;"></div>
      </div>
      
      <div id="locationMap"></div>
    </div>

  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // =============== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù†ÙØ³ Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©) ===============
    const uint8ToBase64 = (buf) => btoa(String.fromCharCode(...new Uint8Array(buf)));
    const base64ToUint8 = (str) => new Uint8Array(atob(str).split('').map(c => c.charCodeAt(0)));

    // =============== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙØ­Ø§Øª ===============
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(a => a.classList.remove('active'));
      
      document.getElementById(pageId).classList.add('active');
      const link = document.querySelector(`.nav-item[data-page="${pageId}"]`);
      if (link) link.classList.add('active');
    }

    // =============== Ø§Ù„ØªØ´ÙÙŠØ± ===============
    async function encryptAndShare() {
      const sender = document.getElementById('senderName').value.trim() || 'Ù…Ø±Ø³ÙÙ„';
      const message = document.getElementById('message').value.trim();
      const password = document.getElementById('password').value;

      if (!message || !password) {
        alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.");
        return;
      }

      try {
        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.getElementById('encryptSpinner').style.display = 'block';
        document.getElementById('linkContainer').classList.add('hidden');

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ
        const timestamp = new Date().toLocaleString('ar-SA');
        const fullText = `ğŸ‘¤ Ø§Ù„Ù…Ø±Ø³Ù„: ${sender}\nğŸ“… Ø§Ù„ÙˆÙ‚Øª: ${timestamp}\nâœ‰ï¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:\n${message}`;

        const encoder = new TextEncoder();
        const data = encoder.encode(fullText);

        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));

        // Ø§Ø´ØªÙ‚Ø§Ù‚ Ø§Ù„Ù…ÙØªØ§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… PBKDF2
        const keyMaterial = await crypto.subtle.importKey(
          "raw", encoder.encode(password),
          { name: "PBKDF2" }, false, ["deriveKey"]
        );

        const aesKey = await crypto.subtle.deriveKey(
          { name: "PBKDF2", salt, iterations: 150000, hash: "SHA-256" },
          keyMaterial,
          { name: "AES-GCM", length: 256 },
          false, ["encrypt"]
        );

        // Ø§Ù„ØªØ´ÙÙŠØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… AES-GCM
        const encrypted = await crypto.subtle.encrypt(
          { name: "AES-GCM", iv }, aesKey, data
        );

        // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const result = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
        result.set(salt, 0);
        result.set(iv, salt.length);
        result.set(new Uint8Array(encrypted), salt.length + iv.length);

        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·
        const encryptedB64 = uint8ToBase64(result);
        const urlSafe = encodeURIComponent(encryptedB64);
        const fullUrl = `${window.location.origin}${window.location.pathname}?msg=${urlSafe}`;

        // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø·
        document.getElementById('shareLink').textContent = fullUrl;
        document.getElementById('linkContainer').classList.remove('hidden');
        document.getElementById('encryptSpinner').style.display = 'none';

        // Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠ
        setTimeout(() => copyToClipboard(), 500);

      } catch (err) {
        console.error(err);
        document.getElementById('encryptSpinner').style.display = 'none';
        alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´ÙÙŠØ±: " + (err.message || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
      }
    }

    // =============== Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ===============
    async function copyToClipboard() {
      const link = document.getElementById('shareLink').textContent;
      try {
        await navigator.clipboard.writeText(link);
        document.getElementById('copyStatus').innerHTML = 
          '<i class="fas fa-check-circle" style="color: #38a169;"></i> ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!';
      } catch (err) {
        document.getElementById('copyStatus').innerHTML = 
          '<i class="fas fa-times-circle" style="color: #e53e3e;"></i> ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹';
      }
    }

    // =============== Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ===============
    async function shareViaApps() {
      const link = document.getElementById('shareLink').textContent;
      const shareData = {
        title: 'Ø±Ø³Ø§Ù„Ø© Ù…Ø´ÙØ±Ø© ğŸ”',
        text: 'Ø£Ø±Ø³Ù„Øª Ù„Ùƒ Ø±Ø³Ø§Ù„Ø© Ø³Ø±ÙŠØ© Ù…Ø´ÙØ±Ø©!',
        url: link
      };

      try {
        if (navigator.share) {
          await navigator.share(shareData);
        } else {
          await navigator.clipboard.writeText(link);
          alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·! ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø´Ø§Ø±ÙƒØªÙ‡ Ø§Ù„Ø¢Ù†.');
        }
      } catch (err) {
        console.log('Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ù„ØºØ§Ø©:', err);
      }
    }

    // =============== ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± ===============
    async function decryptMessage() {
      const urlParams = new URLSearchParams(window.location.search);
      const encryptedParam = urlParams.get('msg');
      const password = document.getElementById('decryptPassword').value;

      if (!encryptedParam || !password) {
        alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ù„Ø© Ù…Ø´ÙØ±Ø© Ø£Ùˆ Ù„Ù… ØªÙØ¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.");
        return;
      }

      try {
        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.getElementById('decryptSpinner').style.display = 'block';
        document.getElementById('output').classList.add('hidden');

        const encryptedB64 = decodeURIComponent(encryptedParam);
        const bytes = base64ToUint8(encryptedB64);
        
        if (bytes.length < 28) throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©");

        // ÙØµÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
        const salt = bytes.slice(0, 16);
        const iv = bytes.slice(16, 28);
        const encryptedData = bytes.slice(28);

        const encoder = new TextEncoder();
        
        // Ø§Ø´ØªÙ‚Ø§Ù‚ Ø§Ù„Ù…ÙØªØ§Ø­
        const keyMaterial = await crypto.subtle.importKey(
          "raw", encoder.encode(password),
          { name: "PBKDF2" }, false, ["deriveKey"]
        );

        const aesKey = await crypto.subtle.deriveKey(
          { name: "PBKDF2", salt, iterations: 150000, hash: "SHA-256" },
          keyMaterial,
          { name: "AES-GCM", length: 256 },
          false, ["decrypt"]
        );

        // ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±
        const decrypted = await crypto.subtle.decrypt(
          { name: "AES-GCM", iv }, aesKey, encryptedData
        );
        
        const decoder = new TextDecoder();
        const plaintext = decoder.decode(decrypted);

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        document.getElementById('messageContent').textContent = plaintext;
        document.getElementById('output').classList.remove('hidden');
        document.getElementById('decryptSpinner').style.display = 'none';

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ÙˆÙ‚Ø¹
        const mapDiv = document.getElementById('locationMap');
        mapDiv.style.display = 'none';
        mapDiv.innerHTML = '';
        document.getElementById('locationInfo').classList.add('hidden');

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ù†Øµ
        const locationMatch = plaintext.match(/ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹:\s*\{.*?\}/);
        if (locationMatch) {
          try {
            const locText = locationMatch[0].replace('ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', '').trim();
            const loc = JSON.parse(locText);
            
            document.getElementById('locationInfo').innerHTML = 
              `<i class="fas fa-map-marker-alt"></i> <strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø±ÙÙ‚:</strong> ${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}`;
            document.getElementById('locationInfo').classList.remove('hidden');
            
            mapDiv.style.display = 'block';
            const map = L.map('locationMap').setView([loc.lat, loc.lng], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: 'Â© OpenStreetMap'
            }).addTo(map);
            
            L.marker([loc.lat, loc.lng])
              .addTo(map)
              .bindPopup('ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø±Ø³Ù„')
              .openPopup();
              
          } catch (e) {
            console.warn("Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± ØµØ§Ù„Ø­:", e);
          }
        }

      } catch (err) {
        document.getElementById('decryptSpinner').style.display = 'none';
        document.getElementById('messageContent').textContent = 
          "âŒ ÙØ´Ù„ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±!\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù†:\n1. ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØµØ­ÙŠØ­Ø©\n2. Ø§Ù„Ø±Ø§Ø¨Ø· ÙƒØ§Ù…Ù„\n3. Ø¹Ø¯Ù… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø·";
        document.getElementById('output').classList.remove('hidden');
        document.getElementById('locationMap').style.display = 'none';
      }
    }

    // =============== ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ===============
    window.addEventListener('DOMContentLoaded', () => {
      // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
      document.querySelectorAll('.nav-item').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          showPage(link.dataset.page);
        });
      });

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ø³Ø§Ù„Ø© Ù…Ø´ÙØ±Ø© ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('msg')) {
        showPage('decrypt');
        document.getElementById('messageDetected').classList.remove('hidden');
        setTimeout(() => {
          document.getElementById('decryptPassword').focus();
        }, 300);
      }
    });
  </script>
</body>
</html>




